<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Engineering Thesis Project</title>
    <!--Import Google Icon Font-->
      <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
      <!--Import materialize.css-->
      <link type="text/css" rel="stylesheet" href="css/materialize.min.css"  media="screen,projection"/>

      <!--Let browser know website is optimized for mobile-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<script src="js/plotly-latest.min.js"></script>

</head>
<body>
    <div class="container" style="padding-top: 32px">
        <a class="waves-effect waves-light btn start-button">start processing samples</a>
        <h4>Processed samples:</h4>
        <h4 id="samples">0</h4>
        <h4>Roc Auc score:</h4>
        <h4 id="roc-auc-score">0.000</h4>
    </div>
    <div class="container center">
        <h5>Correct predictions [%]:</h5>
        <div id="models"></div>
    </div>
    <script type="text/javascript">

        class Model {
          constructor(id, x, y) {
            this.id = id;
            this.x = [x];
            this.y = [y];
            this.chart_name = "chart" + id;
            document.getElementById('models').innerHTML += "<div id=\""+ this.chart_name +"\"></div>";
            Plotly.plot(this.chart_name,[{
                y: [y],
                x: x,
                type: 'line'
            }]);
          }

          sayHi() {
              console.log("Hi!");
          }

          addPoint(x, y) {
              this.x.push(x);
              this.y.push(y);
              console.log(y);
              Plotly.extendTraces(
                  this.chart_name,
                  {
                      y: [[y]]
                  },
                  [0]);
          }
        }

        var ws_client = new WebSocket("ws://0.0.0.0:8765");
        var ws_eval = new WebSocket("ws://0.0.0.0:8766");

        var start_button = document.querySelector('.start-button');

        start_button.onclick = async function (event) {
            console.log('start');
            ws_client.send('start');
            ws_eval.send('start');
        };

        Object.filter = (obj, predicate) =>
            Object.keys(obj)
                  .filter( key => predicate(obj[key]) )
                  .reduce( (res, key) => (res[key] = obj[key], res), {} );

        var cnt = 0;
        models = [];
        model_ids = [];
        ws_eval.onmessage = async function (event) {
            var message = JSON.parse(event.data);
            console.log(message);

            for(var key in message) {
                if(message.hasOwnProperty(key)) {
                    model = message[key];
                    console.log(model);
                    let correct_prediction_ratio = model["correct_predictions"] / model["processed_samples"];
                    if(model_ids.includes(model.id)) {
                        let current_model = Object.filter(models, obj => obj.id === model.id);
                        console.log(current_model);
                        current_model[0].sayHi();
                        current_model[0].addPoint(model["processed_samples"], correct_prediction_ratio.toPrecision([3]));
                    } else {
                        let model_obj = new Model(model.id, model["processed_samples"], correct_prediction_ratio);
                        models.push(model_obj);
                        model_ids.push(model.id);
                        console.log(models);
                        console.log(model_ids);
                    }
                    cnt++;

                    var samples = document.getElementById("samples");
                    samples.innerHTML = model["processed_samples"];
                    var roc_auc_score = document.getElementById("roc-auc-score");
                    roc_auc_score.innerHTML = model["roc_auc_score"].toPrecision([3]);
                }
            }

            if(cnt > 500) {
                Plotly.relayout('chart',{
                    xaxis: {
                        range: [cnt-500,cnt]
                    }
                });
            }
        }

    </script>
    <script type="text/javascript" src="js/materialize.min.js"></script>
</body>
</html>