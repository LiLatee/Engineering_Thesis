<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Engineering Thesis Project</title>
    <!--Import Google Icon Font-->
      <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
      <!--Import materialize.css-->
      <link type="text/css" rel="stylesheet" href="css/materialize.min.css"  media="screen,projection"/>

      <!--Let browser know website is optimized for mobile-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<script src="js/plotly-latest.min.js"></script>

</head>
<body>
    <div class="container" style="padding-top: 32px">
<!-- TODO: default values for inputs -->
      Training dataset size: <input type="number" value="10000" id="training_dataset_size"><br>
      Number of samples between model updates: <input type="number" value="1000" id="samples_model_updates"><br>
      <input type="submit" class="waves-effect waves-light btn start-button" value="start processing samples">
    </div>
    <div class="container" style="padding-top: 32px">
        <h4>Processed samples:</h4>
        <h4 id="samples">0</h4>
    </div>
    <div class="container center">
        <h5>Correct predictions [%]:</h5>
        <div id="correct-predictions"></div>
        <h5>Auc-Roc:</h5>
        <div id="auc-roc"></div>
    </div>
    <script type="text/javascript">
        function change_parameters(training_dataset_size, samples_model_updates){
            alert(training_dataset_size.value);
            document.getElementById('form_parameters')[0].placeholder = training_dataset_size.value;
            return 0;
        }

        Plotly.plot("correct-predictions", [
                {y: [0], x: 0, name: "model 1"},
                {y: [0], x: 0, name: "model 2"},
                {y: [0], x: 0, name: "model 3"},
                {y: [0], x: 0, name: "model 4"},
                {y: [0], x: 0, name: "model 5"},
                {y: [0], x: 0, name: "model 6"},
                {y: [0], x: 0, name: "model 7"},
                {y: [0], x: 0, name: "model 8"}
        ]);

        Plotly.plot("auc-roc", [
                {y: [0], x: 0, name: "model 1"},
                {y: [0], x: 0, name: "model 2"},
                {y: [0], x: 0, name: "model 3"},
                {y: [0], x: 0, name: "model 4"},
                {y: [0], x: 0, name: "model 5"},
                {y: [0], x: 0, name: "model 6"},
                {y: [0], x: 0, name: "model 7"},
                {y: [0], x: 0, name: "model 8"}
        ]);

        var ws_client = new WebSocket("ws://0.0.0.0:8765");
        var ws_eval = new WebSocket("ws://0.0.0.0:8766");

        var start_button = document.querySelector('.start-button');

        start_button.onclick = async function (event) {
            console.log('start');
            let message = {
                'start': true,
                'training_dataset_size': document.getElementById('training_dataset_size').value,
                'samples_model_updates': document.getElementById('samples_model_updates').value
            };
            ws_client.send(JSON.stringify(message));
            ws_eval.send('start');
        };

        var cnt = 0;
        let max_currently_processed_samples = 0;
        var samples = document.getElementById("samples");
        ws_eval.onmessage = async function (event) {
            var message = JSON.parse(event.data);
            console.log(message);
            let list_of_correct_prediction_ratio = [[0], [0], [0], [0], [0], [0], [0], [0]];
            let list_of_aucroc = [[0], [0], [0], [0], [0], [0], [0], [0]];
            for(var key in message) {
                if (message.hasOwnProperty(key)) {
                    model = message[key];
                    console.log(model);
                    list_of_correct_prediction_ratio[model.id - 1] = [model["correct_predictions"] / model["processed_samples"]];
                    list_of_aucroc[model.id - 1] = [model["roc_auc_score"].toPrecision([3])];
                    if (model['processed_samples'] > max_currently_processed_samples) {
                        max_currently_processed_samples = model['processed_samples'];
                    }
                    cnt++;
                }
            }
            samples.innerHTML = max_currently_processed_samples;
            Plotly.extendTraces(
              "correct-predictions",
              {
                  y: list_of_correct_prediction_ratio
              },
              [0,1,2,3,4,5,6,7]);
            Plotly.extendTraces(
              "auc-roc",
              {
                  y: list_of_aucroc
              },
              [0,1,2,3,4,5,6,7]);

            if(cnt > 500) {
                Plotly.relayout("correct-predictions",{
                    xaxis: {
                        range: [cnt-500,cnt]
                    }
                });
                Plotly.relayout("auc-roc",{
                    xaxis: {
                        range: [cnt-500,cnt]
                    }
                });
            }
        }

    </script>
    <script type="text/javascript" src="js/materialize.min.js"></script>
</body>
</html>