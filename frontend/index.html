<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Engineering Thesis Project</title>
    <!--Import Google Icon Font-->
      <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
      <!--Import materialize.css-->
      <link type="text/css" rel="stylesheet" href="css/materialize.min.css"  media="screen,projection"/>

      <!--Let browser know website is optimized for mobile-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<script src="js/plotly-latest.min.js"></script>

</head>
<body>
    <div class="container" style="padding-top: 32px">
      Training dataset size: <input type="number" value="10000" id="training_dataset_size"><br>
      Number of samples between model updates: <input type="number" value="1000" id="samples_model_updates"><br>
      <input type="submit" class="waves-effect waves-light btn start-button" value="start processing samples">
    </div>
    <div class="container" style="padding-top: 32px">
        <h4>Processed samples:</h4>
        <h4 id="samples">0</h4>
    </div>
    <div class="container center">
        <h5>Accuracy:</h5>
        <div id="accuracy"></div>
        <h5>Auc-Roc:</h5>
        <div id="auc-roc"></div>
        <h5>F1 score:</h5>
        <div id="f1"></div>
    </div>
    <script type="text/javascript">
        var layout_accuracy = {
            title: 'Accuracy',
            datarevision: 0,
            xaxis: {
                title: 'Number of samples',
                showgrid: false,
                zeroline: false,
                autorange: true,
            },
            yaxis: {
                title: 'Accuracy [%]',
                showline: false,
                autorange: true,
            },
        };
        var data_accuracy = [
            {y: [], x: [], name: "model 1", first_processed_sample: 0},
            {y: [], x: [], name: "model 2", first_processed_sample: -1},
            {y: [], x: [], name: "model 3", first_processed_sample: -1},
            {y: [], x: [], name: "model 4", first_processed_sample: -1},
            {y: [], x: [], name: "model 5", first_processed_sample: -1},
            {y: [], x: [], name: "model 6", first_processed_sample: -1},
            {y: [], x: [], name: "model 7", first_processed_sample: -1},
            {y: [], x: [], name: "model 8", first_processed_sample: -1},
        ];
        Plotly.newPlot("accuracy", data_accuracy, layout_accuracy);

        Plotly.plot("auc-roc", [
                {y: [0], x: 0, name: "model 1"},
                {y: [0], x: 0, name: "model 2"},
                {y: [0], x: 0, name: "model 3"},
                {y: [0], x: 0, name: "model 4"},
                {y: [0], x: 0, name: "model 5"},
                {y: [0], x: 0, name: "model 6"},
                {y: [0], x: 0, name: "model 7"},
                {y: [0], x: 0, name: "model 8"}
        ]);

        Plotly.plot("f1", [
                {y: [0], x: 0, name: "model 1"},
                {y: [0], x: 0, name: "model 2"},
                {y: [0], x: 0, name: "model 3"},
                {y: [0], x: 0, name: "model 4"},
                {y: [0], x: 0, name: "model 5"},
                {y: [0], x: 0, name: "model 6"},
                {y: [0], x: 0, name: "model 7"},
                {y: [0], x: 0, name: "model 8"}
        ]);

        var ws_client = new WebSocket("ws://0.0.0.0:8765");
        var ws_eval = new WebSocket("ws://0.0.0.0:8766");

        var start_button = document.querySelector('.start-button');

        start_button.onclick = async function (event) {
            console.log('start');
            start_button.disabled = true;
            let message = {
                'start': true,
                'training_dataset_size': document.getElementById('training_dataset_size').value,
                'samples_model_updates': document.getElementById('samples_model_updates').value
            };
            ws_client.send(JSON.stringify(message));
            ws_eval.send('start');
        };

        var cnt = 0;
        let max_currently_processed_samples = 0;
        var samples = document.getElementById("samples");
        ws_eval.onmessage = async function (event) {
            var message = JSON.parse(event.data);
            console.log(message);
            let list_of_aucroc = [[0], [0], [0], [0], [0], [0], [0], [0]];
            let list_of_f1 = [[0], [0], [0], [0], [0], [0], [0], [0]];
            for(var key in message) {
                if (message.hasOwnProperty(key)) {
                    model = message[key];
                    console.log(model);
                    data_accuracy[model.id - 1].y.push(model["correct_predictions"] / model["processed_samples"]);
                    // TODO: set accurate number of first processed sample
                    if (data_accuracy[model.id - 1].first_processed_sample === -1){
                        data_accuracy[model.id - 1].first_processed_sample = max_currently_processed_samples;
                    }
                    data_accuracy[model.id - 1].x.push(
                        model["processed_samples"] + data_accuracy[model.id - 1].first_processed_sample);
                    list_of_aucroc[model.id - 1] = [model["roc_auc_score"].toPrecision([3])];
                    list_of_f1[model.id - 1] = [model["f1_score"].toPrecision([3])];
                    if (model['processed_samples'] > max_currently_processed_samples) {
                        max_currently_processed_samples = model['processed_samples'];
                    }
                    cnt++;
                }
            }
            samples.innerHTML = max_currently_processed_samples;
            console.log(data_accuracy);
            Plotly.react("accuracy", data_accuracy, layout_accuracy);
            layout_accuracy.xaxis.autorange = true;
	        layout_accuracy.yaxis.autorange = true;
	        layout_accuracy.datarevision += 1;
            Plotly.extendTraces(
              "auc-roc",
              {
                  y: list_of_aucroc
              },
              [0,1,2,3,4,5,6,7]);

            Plotly.extendTraces(
              "f1",
              {
                  y: list_of_f1
              },
              [0,1,2,3,4,5,6,7]);
            if(cnt > 500) {
                Plotly.relayout("accuracy",{
                    xaxis: {
                        range: [cnt-500,cnt]
                    }
                });
                Plotly.relayout("auc-roc",{
                    xaxis: {
                        range: [cnt-500,cnt]
                    }
                });
                Plotly.relayout("f1",{
                    xaxis: {
                        range: [cnt-500,cnt]
                    }
                });
            }
        }

    </script>
    <script type="text/javascript" src="js/materialize.min.js"></script>
</body>
</html>